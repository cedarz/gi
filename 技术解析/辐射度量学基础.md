# 辐射度量学(Radiometry)基础 - 深度解析

## 为什么要学习辐射度量学？

辐射度量学是理解全局光照的**物理基础**，它用精确的数学语言描述光的传播、测量和能量转换。没有辐射度量学，渲染方程就是一堆符号；有了辐射度量学，你就能理解每个像素背后的物理过程。

**学习目标**:
- 理解光作为电磁辐射的物理量
- 掌握描述光传播的四个核心辐射量
- 建立从物理世界到渲染算法的桥梁
- 为学习BRDF和渲染方程打下坚实基础

---

## 1. 立体角 (Solid Angle)

### 1.1 从平面角到立体角

在理解辐射量之前，我们先要理解**立体角**这个概念。

#### 平面角回顾
```
平面角 θ = 弧长 / 半径
        = s / r
单位: 弧度(radian)，圆周对应 2π 弧度
```

#### 立体角定义
立体角是平面角在三维空间的推广：

```
立体角 Ω = 面积 / 半径²
         = A / r²
单位: 球面度(steradian, sr)
```

**物理意义**: 立体角描述从某点看去一个表面"张开的大小"。

**立体角可视化**:
```
        观察点O
          ●
         /|\
        / | \
       /  |  \
      /   |   \
     /    |    \
    /_____|_____\
    \_____A_____/  ← 球面上的面积A
    
    立体角 Ω = A / r²
    
    特殊情况:
    - 整个球面: Ω = 4πr² / r² = 4π sr
    - 半球面:   Ω = 2πr² / r² = 2π sr
    - 小平面:   Ω ≈ dA cos θ / r²  (投影面积)
```

**更多图解**:

<details>
<summary>点击查看：立体角与平面角对比图</summary>

```
平面角 (2D)                立体角 (3D)
    
    r                         r
   ●────→                    ●
  /│                        /|\
 / │θ                      / | \
/  │                      /  |  \
───┘                     /___|___\
 s                      球面面积 A

θ = s/r (弧度)          Ω = A/r² (球面度)
圆周 = 2π rad           球面 = 4π sr
```
</details>

```
示例:
  半球面: Ω = 2π sr
  全球面: Ω = 4π sr
  一个小表面: Ω ≈ dA⊥ / r²
```

**可视化资源**:
- 📊 [Interactive Solid Angle Visualization](https://www.geogebra.org/m/HZ5NxGVu)
- 📺 [Khan Academy: Solid Angles](https://www.khanacademy.org/science/physics)
- 💡 建议：用手电筒照墙，距离越近"张开"越大（立体角越大）

### 1.2 微分立体角

在渲染中，我们常用**球面坐标**表示方向：

```
方向向量 ω = (θ, φ)
  θ: 天顶角 (zenith angle)，[0, π]
  φ: 方位角 (azimuth angle)，[0, 2π]
```

微分立体角表达式：
```
dω = sin θ dθ dφ
```

**可视化**:
```
        Z (法线方向)
        ↑
        |   ω (光线方向)
        |  /
        | /θ
        |/______ Y
       O
      /
     / φ
    X

dω 表示球面上一小块区域对应的立体角
```

### 1.3 半球积分

在着色计算中，我们经常需要对半球面积分：

```
半球积分: ∫_Ω f(ω) dω

其中 Ω 表示以法线为轴的半球面
```

展开为球面坐标：
```
∫_Ω f(ω) dω = ∫₀²ᵖⁱ ∫₀ᵖⁱ/² f(θ, φ) sin θ dθ dφ
```

**常用公式**:
```
1. 半球面立体角: ∫_Ω dω = 2π

2. 余弦加权半球积分: 
   ∫_Ω cos θ dω = π

3. 投影立体角:
   dω⊥ = cos θ dω
```

---

## 2. 四个核心辐射量

辐射度量学用四个相互关联的物理量描述光的传播：

```
         能量 (Energy, Q)
            ↓ 对时间求导
       通量 (Flux, Φ)
          ↙        ↘
  对面积求导      对立体角求导
        ↓              ↓
   辐照度           辐射强度
  (Irradiance, E)  (Intensity, I)
        ↓              ↓
    对立体角求导    对面积求导
        ↘            ↙
       辐射亮度 (Radiance, L)
```

**辐射量关系详解**:
```
能量 Q (焦耳)
    ↓ 单位时间
通量 Φ (瓦特) = dQ/dt
    ↙        ↘
单位面积      单位立体角
    ↓              ↓
辐照度 E         辐射强度 I
(W/m²)          (W/sr)
    ↓              ↓
对立体角微分    对面积微分
    ↘            ↙
    辐射亮度 L (W/(m²·sr))
    
核心：L 是最基础的量，其他都可以从L推导！
```

**微分关系**:
```
Φ = dQ/dt              通量 = 能量的时间导数
I = dΦ/dω              强度 = 通量的立体角导数
E = dΦ/dA              辐照度 = 通量的面积导数
L = d²Φ/(dA·cosθ·dω)  辐射亮度 = 通量的面积和立体角二阶导数
```

**四个辐射量的直观理解**:

<details>
<summary>点击查看：用日常例子理解四个辐射量</summary>

```
场景：一个灯泡照亮房间

1. 辐射能量 Q (焦耳)
   - 灯泡一整天消耗的电能
   - 例如: 60W灯泡亮8小时 = 60W × 8h × 3600s = 1.73 MJ

2. 辐射通量 Φ (瓦特)
   - 灯泡此刻的功率
   - 例如: 60W灯泡就是60W通量

3. 辐射强度 I (W/sr)
   - 灯泡在某个方向上的"亮度"
   - 例如: 60W灯泡均匀发光 → I = 60/(4π) ≈ 4.77 W/sr
   - 如果是聚光灯，某个方向上I会更大

4. 辐照度 E (W/m²)
   - 桌面上接收的光强
   - 例如: 1米距离，E = I/r² = 4.77/1² ≈ 4.77 W/m²
   - 距离2米，E = 4.77/4 ≈ 1.19 W/m²  (距离平方衰减)

5. 辐射亮度 L (W/(m²·sr))
   - 灯丝表面的"发光密度"
   - 不随距离变化！(这就是为什么远处的星星依然明亮)
   - 摄像机/眼睛测量的就是L
```
</details>

**推荐可视化工具**:
- 🎨 [Scratchapixel - Light and Shading](https://www.scratchapixel.com/lessons/3d-basic-rendering/introduction-to-shading)
- 📊 [PhET Interactive Simulations - Light](https://phet.colorado.edu/en/simulations/filter?subjects=light)
- 📖 **推荐阅读**: PBRT Book Chapter 5 有详细的关系图解
- 🎥 [GAMES101 Lecture 14](https://www.bilibili.com/video/BV1X7411F744?p=14) - 闫令琪老师中文讲解

### 2.1 辐射能量 (Radiant Energy)

**定义**: 光携带的能量
- 符号: \( Q \)
- 单位: 焦耳 (Joule, J)

**物理意义**: 
- 单个光子能量: \( E = hν \) (h为普朗克常数，ν为频率)
- 渲染中通常不直接使用，而是用功率(通量)

---

### 2.2 辐射通量 (Radiant Flux / Power)

**定义**: 单位时间通过的辐射能量

\[
\Phi = \frac{dQ}{dt}
\]

- 符号: \( \Phi \)
- 单位: 瓦特 (Watt, W) = J/s

**物理意义**: 功率，描述光源发出或表面接收的总能量速率

**示例**:
```
点光源: 
  发光功率 Φ = 100W
  均匀发射，则每个立体角的强度 I = Φ / (4π)

太阳光:
  总功率约 3.8 × 10²⁶ W
  到达地球表面约 1000 W/m²
```

**在渲染中**:
- 光源的"brightness"参数常表示通量
- Area Light的总功率 = 辐射亮度 × 面积 × π

---

### 2.3 辐射强度 (Radiant Intensity)

**定义**: 单位立体角上的辐射通量

\[
I(\omega) = \frac{d\Phi}{d\omega}
\]

- 符号: \( I \)
- 单位: W/sr (瓦特每球面度)

**物理意义**: 描述点光源在某个方向上的"亮度"

**特点**:
- 只适用于**点光源** (0维光源)
- 与距离无关 (点光源的固有属性)
- 方向相关 (可以有方向性)

**示例**:
```cpp
// 均匀点光源 (Omnidirectional)
float I_uniform = Power / (4.0 * PI);

// 方向性光源 (Spotlight)
float I_spot(vec3 direction) {
    float cosTheta = dot(direction, lightDir);
    if (cosTheta > cosCutoff) {
        return Power * spotlight_falloff(cosTheta);
    }
    return 0.0;
}
```

**反平方衰减定律**:
```
从点光源出发的光，在距离 r 处的辐照度:
E(r) = I / r²

这就是著名的 1/r² 衰减！
```

---

### 2.4 辐照度 (Irradiance)

**定义**: 单位面积上接收的辐射通量

\[
E(p) = \frac{d\Phi}{dA}
\]

- 符号: \( E \)
- 单位: W/m² (瓦特每平方米)

**物理意义**: 表面某点接收到的"光照强度"

**完整定义** (考虑入射角):
\[
E(p) = \int_{\Omega} L_i(p, \omega) \cos\theta \, d\omega
\]

其中 \( \cos\theta \) 是Lambert余弦定律的体现。

**示例场景**:
```
地面上的辐照度:
  直射阳光: E ≈ 1000 W/m²
  阴天: E ≈ 100-300 W/m²
  室内: E ≈ 10-100 W/m²
  月光: E ≈ 1 W/m²
```

**Lambert余弦定律**:
```
      光源
        ↓ 
     ━━━━━━  ← 垂直表面，E = E₀
        
     ╱╱╱╱╱╱  ← 倾斜θ角，E = E₀ cos θ
```

**代码示例**:
```cpp
// 点光源产生的辐照度
float pointLightIrradiance(vec3 position, vec3 normal) {
    vec3 L = lightPos - position;
    float dist = length(L);
    L = L / dist; // 归一化
    
    float I = lightIntensity; // 辐射强度
    float cosTheta = max(0.0, dot(normal, L));
    
    return I * cosTheta / (dist * dist); // E = I·cosθ / r²
}
```

---

### 2.5 辐射亮度 (Radiance) ⭐ 核心概念

**定义**: 单位投影面积、单位立体角上的辐射通量

\[
L(p, \omega) = \frac{d^2\Phi}{dA^\perp \, d\omega} = \frac{d^2\Phi}{dA \cos\theta \, d\omega}
\]

- 符号: \( L \)
- 单位: W/(m²·sr) (瓦特每平方米每球面度)

**物理意义**: 
- 描述光在空间中某点、某方向上的"密度"
- **渲染方程的核心量** - 我们计算的就是Radiance！

**Radiance的几何定义**:
```
        dω (立体角)
         ↗
        /
       / θ
    dA●────→ 法线N
    表面
    
L = d²Φ / (dA · cos θ · dω)

组成部分:
- dA: 表面微元面积
- cos θ: 投影因子 (Lambert余弦)
- dω: 立体角微元
- d²Φ: 二阶微分通量
```

![Radiance Geometry](https://www.scratchapixel.com/images/upload/shading-intro/shad-radiometry-6.png?)
> 图片来源: [Scratchapixel - Introduction to Shading](https://www.scratchapixel.com/lessons/3d-basic-rendering/introduction-to-shading/shading-lights.html)

**为什么Radiance如此重要？**

1. **不随距离衰减**: 
   ```
   光线在真空中传播，Radiance保持不变！
   (这就是为什么远处的星星依然明亮)
   ```

2. **摄像机测量的是Radiance**:
   ```
   像素值 ∝ L(p, ω_camera)
   ```

3. **渲染方程求解的是Radiance**:
   ```
   L_o(p, ω_o) = L_e(p, ω_o) + ∫_Ω f_r(p, ω_i, ω_o) L_i(p, ω_i) cosθ_i dω_i
   ```

<details>
<summary>点击查看：Radiance不衰减的直观理解</summary>

```
为什么Radiance不随距离衰减？

场景：观察一个发光圆盘

距离 r₁:
  ┌─────┐
  │圆盘 │ 发出的Radiance = L
  └─────┘
     ↓  ← 观察者看到的立体角 = Ω₁
     👁

距离 r₂ = 2×r₁:
  ┌─────┐
  │圆盘 │ 发出的Radiance = L (不变!)
  └─────┘
      ↓  ← 观察者看到的立体角 = Ω₂ = Ω₁/4
      
      👁

解释：
- 距离翻倍，立体角变为1/4
- 接收的总功率 = L × Ω (确实变为1/4)
- 但Radiance本身不变！

类比：
就像看远处的灯，虽然"总亮度"变暗了，
但灯本身的"亮度密度"(每单位面积每单位立体角)不变。
```
</details>

### Radiance的两个视角

**1. 从表面出发** (Exitant Radiance):
```
L_o(p, ω) = 单位面积、单位立体角发出的通量
```

**2. 向表面入射** (Incident Radiance):
```
L_i(p, ω) = 单位面积、单位立体角到达的通量
```

**关系图**:
```
    光源                表面
     L_e    ──→    L_i  →  反射  →  L_o  ──→  摄像机
  (发射亮度)   (入射亮度)    (BRDF)  (出射亮度)
```

---

## 3. 辐射量之间的关系

### 3.1 从点光源到表面

```
点光源 (Intensity I)
    ↓ 传播距离 r
入射辐照度: E = I / r²
    ↓ 从立体角推导
入射辐射亮度: L_i = I / r²  (对于小光源)

实际上: L_i = I / (dA_light · cos θ_light)
```

### 3.2 从面光源到表面

```
面光源 (Radiance L, 面积 A)
    ↓
总通量: Φ = L · A · π  (Lambertian发射器)
    ↓
某点接收的辐照度: E = ∫_A L · cos θ_i · cos θ_o / r² dA_light
```

### 3.3 辐照度与辐射亮度

关键公式：
\[
E(p) = \int_{\Omega} L_i(p, \omega) \cos\theta \, d\omega
\]

**均匀环境光照下**:
\[
E = \int_{\Omega} L_{env} \cos\theta \, d\omega = L_{env} \cdot \pi
\]

这就是为什么 **π** 在渲染中无处不在！

---

## 4. BRDF - 双向反射分布函数

### 4.1 BRDF的定义

**Bidirectional Reflectance Distribution Function**

\[
f_r(p, \omega_i, \omega_o) = \frac{dL_o(p, \omega_o)}{dE_i(p, \omega_i)} = \frac{dL_o(p, \omega_o)}{L_i(p, \omega_i) \cos\theta_i \, d\omega_i}
\]

- 单位: sr⁻¹ (1/球面度)

**物理意义**: 从方向 \(\omega_i\) 入射的光，有多少比例反射到方向 \(\omega_o\)

**BRDF几何关系**:
```
          法线 N
            ↑
            |
            |     出射方向 ωo
            |    ↗
            |  ↗  θo
    ────────●──────── 表面
          ↙ |
        ↙   |
    θi ↙    |
     ωi     |
  入射方向  |

BRDF: f_r(ωi, ωo) 描述 ωi → ωo 的反射比例
```

**BRDF的3D可视化**:

<details>
<summary>点击查看：不同材质的BRDF形状</summary>

```
Lambertian (漫反射)          镜面反射              粗糙金属
                           (Perfect Mirror)      (GGX, roughness=0.3)

  ωo (所有方向均匀)           ωo (只有一个方向)      ωo (主要在镜面方向)
   ↗ ↑ ↖                        ↑                   ↗ ↑ ↖
  ←  ●  →  表面               ●  表面              ← ● →  表面
   ↙ ↓ ↘                      ↓                    ↙ ↓ ↘
     ωi                      ωi                     ωi

BRDF形状:                  BRDF形状:              BRDF形状:
    ___                        |                     /|\
   /   \                       |                    / | \
  |  ●  |  (半球)             |●|  (尖峰)          /  ●  \  (凸起)
   \___/                       |                   /       \


特点:                      特点:                  特点:
- f_r = ρ/π (常数)         - Delta函数           - 有主瓣(lobe)
- 能量均匀分布             - 只反射到一个方向      - roughness越大越宽
- 看起来"平"               - 完美镜子            - 能量守恒
```

**实际材质的BRDF**:
```
材质         Diffuse比例    Specular比例    Roughness
────────────────────────────────────────────────
白纸         95%           5%             0.8
塑料         60%           40%            0.3-0.5
金属         0%            100%           0.1-0.4
镜子         0%            100%           0.01
皮肤         70%           30%            0.4-0.6
```
</details>

**BRDF可视化资源**:
- 🎨 [Disney BRDF Explorer](https://github.com/wdas/brdf) - 迪士尼开源的BRDF查看器 ⭐推荐下载
- 📊 [MERL BRDF Database](https://www.merl.com/brdf/) - 100种真实材质的测量BRDF数据
- 🎥 [BRDF可视化视频](https://www.youtube.com/results?search_query=BRDF+visualization) - YouTube搜索
- 📖 [BRDF Explorer在线文档](https://www.disneyanimation.com/technology/brdf.html)

**BRDF的特性**:

1. **非负性**: 
   ```
   f_r(ω_i, ω_o) ≥ 0
   ```

2. **Helmholtz互易性**:
   ```
   f_r(ω_i, ω_o) = f_r(ω_o, ω_i)
   (交换入射和出射方向，BRDF不变)
   ```

3. **能量守恒**:
   ```
   ∫_Ω f_r(ω_i, ω_o) cos θ_o dω_o ≤ 1
   (反射的能量不能超过入射能量)
   ```

### 4.2 常见BRDF模型

#### 1. Lambertian (完全漫反射)

\[
f_r = \frac{\rho}{\pi}
\]

- \(\rho\): 反射率 (albedo)，取值 [0, 1]
- 各向同性，所有方向反射均匀

```cpp
vec3 lambertianBRDF(vec3 albedo) {
    return albedo / PI;
}
```

**为什么除以π?**
```
能量守恒:
∫_hemisphere f_r cos θ dω = ρ/π · π = ρ ≤ 1 ✓
```

#### 2. 完美镜面 (Perfect Specular)

\[
f_r(p, \omega_i, \omega_o) = \frac{\rho_s}{\cos\theta_i} \delta(\omega_o - \omega_r)
\]

- \(\omega_r\): 镜面反射方向
- \(\delta\): Dirac delta函数

```cpp
vec3 reflect(vec3 I, vec3 N) {
    return I - 2.0 * dot(N, I) * N;
}
```

#### 3. Microfacet模型 (Cook-Torrance)

用于表示有一定粗糙度的表面：

\[
f_r(\omega_i, \omega_o) = \frac{D(\omega_h) G(\omega_i, \omega_o) F(\omega_i, \omega_h)}{4 \cos\theta_i \cos\theta_o}
\]

- \(D\): 法线分布函数 (Normal Distribution Function)
- \(G\): 几何遮挡函数 (Geometry Function)
- \(F\): 菲涅尔项 (Fresnel Term)
- \(\omega_h\): 半向量 (half vector)

**常用的NDF - GGX**:
\[
D_{GGX}(\omega_h) = \frac{\alpha^2}{\pi ((\cos\theta_h)^2 (\alpha^2 - 1) + 1)^2}
\]

```cpp
float D_GGX(float NoH, float roughness) {
    float a = roughness * roughness;
    float a2 = a * a;
    float NoH2 = NoH * NoH;
    float denom = NoH2 * (a2 - 1.0) + 1.0;
    return a2 / (PI * denom * denom);
}
```

### 4.3 BTDF和BSDF

**BTDF** (Bidirectional Transmittance Distribution Function):
- 描述透射(折射)
- 用于玻璃、水等透明材质

**BSDF** (Bidirectional Scattering Distribution Function):
- BSDF = BRDF + BTDF
- 统一描述反射和透射

\[
f_s = f_r + f_t
\]

---

## 5. 辐射度量学在渲染中的应用

### 5.1 渲染方程

有了辐射度量学基础，我们就能理解渲染方程：

\[
L_o(p, \omega_o) = L_e(p, \omega_o) + \int_{\Omega} f_r(p, \omega_i, \omega_o) L_i(p, \omega_i) \cos\theta_i \, d\omega_i
\]

**每一项的含义**:
- \(L_o\): 出射辐射亮度 (我们要求解的)
- \(L_e\): 自发光 (Emission)
- \(f_r\): BRDF (材质属性)
- \(L_i\): 入射辐射亮度 (来自其他表面或光源)
- \(\cos\theta_i\): Lambert余弦
- \(d\omega_i\): 积分所有入射方向

### 5.2 直接光照计算

**点光源**:
```cpp
vec3 directLighting(vec3 position, vec3 normal, vec3 viewDir) {
    // 光源方向
    vec3 L = normalize(lightPos - position);
    float dist = length(lightPos - position);
    
    // 入射辐射亮度 (来自点光源)
    float I = lightIntensity; // W/sr
    vec3 L_i = I / (dist * dist); // W/m²
    
    // BRDF
    vec3 f_r = albedo / PI; // Lambertian
    
    // 余弦项
    float cosTheta = max(0.0, dot(normal, L));
    
    // 出射辐射亮度
    return f_r * L_i * cosTheta;
}
```

**面光源**:
```cpp
vec3 areaLightContribution(vec3 position, vec3 normal) {
    vec3 L_o = vec3(0.0);
    
    // 对面光源采样
    for (int i = 0; i < numSamples; i++) {
        vec3 lightPoint = sampleAreaLight();
        vec3 L = normalize(lightPoint - position);
        float dist = length(lightPoint - position);
        
        // 光源上的辐射亮度
        vec3 L_i = lightRadiance / (dist * dist);
        
        // BRDF · L_i · cosθ
        float cosTheta = max(0.0, dot(normal, L));
        L_o += (albedo / PI) * L_i * cosTheta;
    }
    
    return L_o / numSamples;
}
```

### 5.3 环境光遮蔽 (Ambient Occlusion)

环境光遮蔽本质上是辐照度的可见性加权：

\[
AO(p) = \frac{1}{\pi} \int_{\Omega} V(p, \omega) \cos\theta \, d\omega
\]

- \(V(p, \omega)\): 可见性函数 (0或1)

```cpp
float computeAO(vec3 position, vec3 normal, int numSamples) {
    float occlusion = 0.0;
    
    for (int i = 0; i < numSamples; i++) {
        vec3 direction = sampleHemisphere(normal);
        float cosTheta = dot(normal, direction);
        
        // 光线追踪检测遮挡
        if (rayIntersect(position, direction)) {
            occlusion += cosTheta; // 被遮挡
        }
    }
    
    return 1.0 - (occlusion / (numSamples * PI));
}
```

---

## 6. 常见误区与注意事项

### ❌ 误区1: 混淆辐照度和辐射亮度

```
错误: "光源亮度是辐照度"
正确: 
  - 点光源用辐射强度描述
  - 面光源用辐射亮度描述
  - 表面接收的是辐照度
```

### ❌ 误区2: 忘记cosθ项

```
错误: E = ∫ L dω
正确: E = ∫ L cos θ dω

Lambert余弦定律必不可少！
```

### ❌ 误区3: BRDF单位错误

```
错误: BRDF单位是 "无量纲"
正确: BRDF单位是 sr⁻¹

f_r = dL_o / (L_i cos θ dω)
单位: (W/(m²·sr)) / (W/m²) = sr⁻¹
```

### ❌ 误区4: 能量不守恒

```
错误: Lambertian BRDF = albedo
正确: Lambertian BRDF = albedo / π

验证能量守恒:
∫ (ρ/π) cos θ dω = ρ ≤ 1 ✓
```

---

## 7. 实践练习

### 练习1: 推导点光源的辐照度

**题目**: 一个辐射强度为 I = 100 W/sr 的点光源，距离表面 r = 2m，求表面的辐照度（法线朝向光源）。

<details>
<summary>点击查看答案</summary>

```
解:
1. 点光源的辐射强度: I = 100 W/sr

2. 距离 r = 2m 处，微分立体角:
   dω = dA / r²

3. 接收的通量:
   dΦ = I · dω = I · dA / r²

4. 辐照度定义:
   E = dΦ / dA = I / r²
   
5. 代入数值:
   E = 100 / 4 = 25 W/m²

答案: E = 25 W/m²
```
</details>

### 练习2: 验证Lambertian能量守恒

**题目**: 证明 Lambertian BRDF \( f_r = \rho / \pi \) 满足能量守恒。

<details>
<summary>点击查看答案</summary>

```
证明:
能量守恒条件: ∫_Ω f_r(ω_i, ω_o) cos θ_o dω_o ≤ 1

对于Lambertian BRDF:
f_r = ρ / π (常数)

积分:
∫_Ω (ρ/π) cos θ dω

= (ρ/π) ∫₀²ᵖⁱ ∫₀ᵖⁱ/² cos θ · sin θ dθ dφ

= (ρ/π) · 2π · ∫₀ᵖⁱ/² cos θ sin θ dθ

= (ρ/π) · 2π · [sin²θ / 2]₀ᵖⁱ/²

= (ρ/π) · 2π · 1/2

= ρ

结论: 只要 ρ ≤ 1，就满足能量守恒 ✓
```
</details>

### 练习3: 计算半球辐照度

**题目**: 均匀环境光 \( L_{env} = 1 \, W/(m^2 \cdot sr) \)，计算平面接收的总辐照度。

<details>
<summary>点击查看答案</summary>

```
解:
E = ∫_Ω L_env cos θ dω

= L_env ∫₀²ᵖⁱ ∫₀ᵖⁱ/² cos θ sin θ dθ dφ

= L_env · 2π · [sin²θ / 2]₀ᵖⁱ/²

= L_env · 2π · 1/2

= L_env · π

代入 L_env = 1:
E = π W/m²

答案: E = π ≈ 3.14 W/m²

这就是著名的 "π因子"！
```
</details>

---

## 8. 进阶话题

### 8.1 光谱辐射度量学

实际上，所有辐射量都是波长相关的：

\[
L(\lambda, p, \omega) \quad \text{单位: W/(m²·sr·nm)}
\]

在渲染中的简化：
- RGB三通道分别计算
- 或使用SPD (Spectral Power Distribution)

### 8.2 光度学 (Photometry)

光度学是辐射度量学的感知版本，加入了人眼响应：

| 辐射量 | 光度量 | 单位 |
|--------|--------|------|
| Radiant Flux | Luminous Flux | 流明(lm) |
| Radiance | Luminance | cd/m² |
| Irradiance | Illuminance | 勒克斯(lux) |

转换关系：
\[
\Phi_v = 683 \int V(\lambda) \Phi_e(\lambda) d\lambda
\]

- \(V(\lambda)\): 人眼视觉效率函数 (CIE 1931)
- 峰值在 555nm (绿光)

### 8.3 次表面散射 (Subsurface Scattering)

对于半透明材质，光会进入表面内部：

\[
L_o(p_o, \omega_o) = \int_A \int_{\Omega} S(p_i, \omega_i; p_o, \omega_o) L_i(p_i, \omega_i) \cos\theta_i \, d\omega_i \, dA(p_i)
\]

- \(S\): BSSRDF (Bidirectional Surface Scattering Reflectance Distribution Function)
- 比BRDF多了一个空间维度

---

## 9. 优质开源代码参考

### 9.1 完整渲染器实现

#### 1. PBRT - Physically Based Rendering Toolkit
**⭐⭐⭐ 强烈推荐**

- 📦 仓库: [mmp/pbrt-v3](https://github.com/mmp/pbrt-v3) / [pbrt-v4](https://github.com/mmp/pbrt-v4)
- 📚 配套书籍: "Physically Based Rendering" (教科书级质量)
- 🎯 亮点: 
  - 完整的辐射度量学实现
  - 每行代码都有详细注释
  - 与教材完全对应

**关键文件**:
```cpp
// 辐射量相关
src/core/spectrum.h     // 光谱表示
src/core/reflection.h   // BRDF/BSDF实现

// Lambertian BRDF实现
class LambertianReflection : public BxDF {
    Spectrum f(const Vector3f &wo, const Vector3f &wi) const {
        return R * InvPi; // R是反射率，InvPi = 1/π
    }
    
    Float Pdf(const Vector3f &wo, const Vector3f &wi) const {
        return SameHemisphere(wo, wi) ? AbsCosTheta(wi) * InvPi : 0;
    }
};

// GGX微表面BRDF
class MicrofacetReflection : public BxDF {
    Spectrum f(const Vector3f &wo, const Vector3f &wi) const {
        Float cosThetaO = AbsCosTheta(wo);
        Float cosThetaI = AbsCosTheta(wi);
        if (cosThetaI == 0 || cosThetaO == 0) return Spectrum(0.);
        
        Vector3f wh = wi + wo;
        if (wh.x == 0 && wh.y == 0 && wh.z == 0) return Spectrum(0.);
        wh = Normalize(wh);
        
        Spectrum F = fresnel->Evaluate(Dot(wi, wh));
        return R * distribution->D(wh) * distribution->G(wo, wi) * F /
               (4 * cosThetaI * cosThetaO);
    }
};
```

**学习路径**:
1. 阅读 `src/core/reflection.h` - BRDF基础类
2. 阅读 `src/core/microfacet.h` - 微表面分布函数
3. 阅读 `src/integrators/path.cpp` - 路径追踪器

---

#### 2. Mitsuba Renderer
**⭐⭐⭐ 研究级渲染器**

- 📦 仓库: [mitsuba-renderer/mitsuba3](https://github.com/mitsuba-renderer/mitsuba3)
- 🎯 亮点: 
  - 支持微分渲染
  - 模块化设计
  - Python绑定

**关键代码示例**:
```cpp
// Diffuse BRDF (Mitsuba风格)
class DiffuseBSDF : public BSDF {
    Spectrum eval(const BSDFContext &ctx,
                  const SurfaceInteraction3f &si,
                  const Vector3f &wo) const {
        Float cos_theta_i = Frame3f::cos_theta(si.wi);
        Float cos_theta_o = Frame3f::cos_theta(wo);
        
        if (cos_theta_i <= 0.0f || cos_theta_o <= 0.0f)
            return 0.0f;
            
        return m_reflectance->eval(si) * InvPi;
    }
};
```

**推荐学习文件**:
- `src/bsdfs/diffuse.cpp` - 漫反射BRDF
- `src/bsdfs/roughconductor.cpp` - GGX金属
- `src/integrators/path.cpp` - 路径追踪

---

#### 3. Ray Tracing in One Weekend 系列
**⭐⭐ 入门友好**

- 📦 仓库: [RayTracing/raytracing.github.io](https://github.com/RayTracing/raytracing.github.io)
- 🎯 亮点: 
  - 从零开始
  - 代码简洁易懂
  - 配套教程完整

**核心代码片段**:
```cpp
// Lambertian材质
class Lambertian : public Material {
public:
    bool scatter(const Ray& r_in, const HitRecord& rec,
                 Color& attenuation, Ray& scattered) const override {
        // 半球采样
        vec3 scatter_direction = rec.normal + random_unit_vector();
        
        // 防止退化
        if (scatter_direction.near_zero())
            scatter_direction = rec.normal;
            
        scattered = Ray(rec.p, scatter_direction);
        attenuation = albedo; // 注意: 这里没除π是因为采样PDF已经处理
        return true;
    }
    
private:
    Color albedo;
};
```

---

### 9.2 实时渲染引擎

#### 4. Filament - Google移动PBR引擎
**⭐⭐⭐ 工业级质量**

- 📦 仓库: [google/filament](https://github.com/google/filament)
- 📖 文档: [Filament PBR Guide](https://google.github.io/filament/Filament.html)
- 🎯 亮点: 
  - 移动优化
  - 详细的数学推导文档
  - 完整的PBR实现

**BRDF着色器代码**:
```glsl
// Standard BRDF实现 (Filament)
vec3 BRDF(
    vec3 v,              // 视线方向
    vec3 l,              // 光线方向
    vec3 n,              // 法线
    float roughness,
    vec3 f0              // F0菲涅尔
) {
    vec3 h = normalize(v + l);
    float NoV = abs(dot(n, v)) + 1e-5;
    float NoL = clamp(dot(n, l), 0.0, 1.0);
    float NoH = clamp(dot(n, h), 0.0, 1.0);
    float LoH = clamp(dot(l, h), 0.0, 1.0);
    
    // 法线分布 (GGX)
    float D = D_GGX(NoH, roughness);
    
    // 可见性函数
    float V = V_SmithGGXCorrelated(NoV, NoL, roughness);
    
    // 菲涅尔项
    vec3 F = F_Schlick(LoH, f0);
    
    // 镜面反射 BRDF
    vec3 Fr = (D * V) * F;
    
    // 漫反射 BRDF (能量守恒)
    vec3 Fd = diffuseColor * Fd_Lambert();
    
    return Fd + Fr;
}

float D_GGX(float NoH, float roughness) {
    float a = roughness * roughness;
    float a2 = a * a;
    float f = (NoH * a2 - NoH) * NoH + 1.0;
    return a2 / (PI * f * f);
}
```

**推荐学习文件**:
- `shaders/src/brdf.fs` - BRDF实现
- `shaders/src/light_indirect.fs` - 间接光照
- `libs/ibl/src/CubemapIBL.cpp` - 基于图像的光照

---

#### 5. Unreal Engine 源码
**⭐⭐⭐ AAA级参考**

- 📦 仓库: [EpicGames/UnrealEngine](https://github.com/EpicGames/UnrealEngine) (需要Epic账号)
- 🎯 亮点: 
  - 工业级优化
  - 完整的GI系统
  - Lumen实现

**关键文件路径**:
```
Engine/Shaders/Private/
  ├── BRDF.ush                 // BRDF实现
  ├── DeferredLightingCommon.ush  // 光照计算
  ├── MonteCarlo.ush          // 蒙特卡洛采样
  └── GlobalIllumination/     // GI相关着色器
```

**BRDF代码示例**:
```hlsl
// UE5的标准BRDF (简化版)
float3 StandardBRDF(
    float3 DiffuseColor,
    float3 SpecularColor,
    float Roughness,
    float3 V,
    float3 L,
    float3 N
) {
    float3 H = normalize(V + L);
    float NoL = saturate(dot(N, L));
    float NoV = saturate(abs(dot(N, V)) + 1e-5);
    float NoH = saturate(dot(N, H));
    float VoH = saturate(dot(V, H));
    
    // GGX / Trowbridge-Reitz
    float D = D_GGX(Roughness, NoH);
    float Vis = Vis_SmithJointApprox(Roughness, NoV, NoL);
    float3 F = F_Schlick(SpecularColor, VoH);
    
    float3 Diffuse = Diffuse_Lambert(DiffuseColor);
    float3 Specular = (D * Vis) * F;
    
    return Diffuse + Specular;
}
```

---

### 9.3 教学向实现

#### 6. Scratchapixel - 教学代码
**⭐⭐ 概念清晰**

- 🌐 网站: [scratchapixel.com](https://www.scratchapixel.com)
- 🎯 亮点: 
  - 从零讲解
  - 配套详细教程
  - 无依赖实现

**Lambertian采样示例**:
```cpp
// 均匀半球采样
Vec3f uniformSampleHemisphere(const float &r1, const float &r2) {
    float sinTheta = sqrtf(1 - r1 * r1);
    float phi = 2 * M_PI * r2;
    float x = sinTheta * cosf(phi);
    float z = sinTheta * sinf(phi);
    return Vec3f(x, r1, z);
}

// 余弦加权半球采样
Vec3f cosineSampleHemisphere(const float &r1, const float &r2) {
    float sinTheta = sqrtf(1 - r1);
    float cosTheta = sqrtf(r1);
    float phi = 2 * M_PI * r2;
    float x = sinTheta * cosf(phi);
    float z = sinTheta * sinf(phi);
    return Vec3f(x, cosTheta, z);
}

// PDF: cos(theta) / π
float pdfCosineWeighted(const Vec3f &w) {
    return w.y * M_1_PI; // w.y 是 cos(theta)
}
```

---

#### 7. TinyRenderer
**⭐ 极简实现**

- 📦 仓库: [ssloy/tinyrenderer](https://github.com/ssloy/tinyrenderer)
- 🎯 亮点: 
  - 500行代码
  - 无外部依赖
  - 适合理解基础

---

### 9.4 实用工具库

#### 8. GLM - OpenGL Mathematics
```cpp
// 使用GLM进行辐射度量学计算
#include <glm/glm.hpp>
#include <glm/gtx/norm.hpp>

// 计算半球积分 (蒙特卡洛)
float computeIrradiance(
    std::function<float(glm::vec3)> radiance,
    glm::vec3 normal,
    int numSamples
) {
    float irradiance = 0.0f;
    
    for (int i = 0; i < numSamples; i++) {
        // 余弦加权采样
        glm::vec3 direction = cosineSampleHemisphere(normal);
        float cosTheta = glm::dot(direction, normal);
        
        // E = ∫ L cos θ dω
        // Monte Carlo: (1/N) Σ L(ωi) cos θi / pdf(ωi)
        // 余弦加权pdf = cos θ / π
        irradiance += radiance(direction) * cosTheta / (cosTheta / M_PI);
    }
    
    return irradiance / numSamples;
}
```

---

### 9.5 在线可视化工具

1. **Shadertoy** - 实时着色器实验
   - 🌐 [shadertoy.com](https://www.shadertoy.com)
   - 搜索: "BRDF", "path tracing", "radiometry"
   - 推荐shader: [Simple Path Tracer](https://www.shadertoy.com/view/4sfGDB)

2. **GeoGebra** - 数学可视化
   - 🌐 [geogebra.org](https://www.geogebra.org)
   - 用于可视化立体角、半球积分等

3. **Desmos** - 函数绘图
   - 🌐 [desmos.com/calculator](https://www.desmos.com/calculator)
   - 绘制BRDF分布、NDF等

---

### 9.6 代码学习路线建议

```
第1周: 基础理解
  └─ 阅读 Ray Tracing in One Weekend
     └─ 实现基础光线追踪
        └─ 验证Lambertian BRDF

第2-3周: 深入PBRT
  └─ 阅读 PBRT Chapter 5 + 代码
     └─ 理解 Spectrum、BRDF类设计
        └─ 实现 GGX微表面模型

第4周: 实时渲染
  └─ 研究 Filament着色器
     └─ 移植到自己的渲染器
        └─ 对比离线vs实时

第5周+: 工业实践
  └─ 研究 Unreal/Unity源码
     └─ 学习优化技巧
        └─ 实现混合GI系统
```

---

## 10. 学习资源与路线图

### 推荐阅读顺序

1. **入门** (1-2天):
   - GAMES101 Lecture 13-14
   - 理解四个辐射量的定义

2. **深入** (3-5天):
   - PBRT Chapter 5.4-5.6
   - 手推公式，特别是半球积分

3. **实践** (1周):
   - 实现简单的路径追踪器
   - 验证辐射量的计算

4. **进阶** (持续):
   - "Advanced Global Illumination" Chapter 2
   - "Radiometry and Reflectance" 论文

### 核心公式速查表

```
立体角: dω = sin θ dθ dφ

半球积分: ∫_Ω dω = 2π

余弦加权: ∫_Ω cos θ dω = π

Radiance → Irradiance:
E = ∫_Ω L cos θ dω

点光源辐照度:
E = I cos θ / r²

BRDF定义:
f_r = dL_o / (L_i cos θ_i dω_i)

Lambertian BRDF:
f_r = ρ / π

渲染方程:
L_o = L_e + ∫_Ω f_r L_i cos θ dω
```

---

## 10. 常见问题 FAQ

**Q1: 为什么渲染中到处都是π？**

A: 因为半球积分！
```
∫_hemisphere cos θ dω = π
这是Lambertian材质能量守恒的关键。
```

**Q2: Radiance为什么不随距离衰减？**

A: Radiance是"密度"概念：
```
虽然总能量随距离平方衰减，但
立体角也随距离平方衰减，
两者相抵，Radiance保持不变！
```

**Q3: 如何理解BRDF的单位 sr⁻¹？**

A: BRDF是"比率"：
```
f_r = (出射Radiance增量) / (入射Irradiance增量)
    = [W/(m²·sr)] / [W/m²]
    = sr⁻¹
```

**Q4: 实际渲染需要计算所有这些量吗？**

A: 现代渲染器通常只计算Radiance：
```
Path Tracing: 追踪Radiance
Rasterization: 计算辐照度，然后转换为Radiance
```

---

## 11. 下一步学习

掌握辐射度量学后，你已经准备好学习：

✅ **渲染方程** - 理解全局光照的数学基础
✅ **蒙特卡洛积分** - 数值求解渲染方程
✅ **路径追踪** - 实现第一个GI算法
✅ **BRDF模型** - 深入理解材质表示

**验收标准**:
- [ ] 能解释四个辐射量的物理意义和单位
- [ ] 能推导点光源的辐照度公式
- [ ] 理解BRDF的定义和能量守恒
- [ ] 能手写渲染方程并解释每一项
- [ ] 知道为什么Lambertian要除以π

---

**文档版本**: v1.0  
**创建日期**: 2025年10月  
**预计学习时间**: 1-2周  
**难度**: ⭐⭐☆☆☆  
**前置知识**: 微积分、基础物理

---

## 参考文献

1. **Pharr, M., Jakob, W., & Humphreys, G.** (2016). *Physically Based Rendering: From Theory to Implementation* (3rd ed.). Chapter 5.
2. **Dutré, P., Bekaert, P., & Bala, K.** (2006). *Advanced Global Illumination* (2nd ed.). Chapter 2.
3. **Nicodemus, F. E.** (1965). "Directional Reflectance and Emissivity of an Opaque Surface". *Applied Optics*.
4. **Veach, E.** (1997). *Robust Monte Carlo Methods for Light Transport Simulation*. PhD Thesis, Chapter 2.

---

## 附录: 额外学习资源

### 📺 视频教程

1. **GAMES101 - 现代计算机图形学入门**
   - 🎥 [Bilibili完整课程](https://www.bilibili.com/video/BV1X7411F744)
   - Lecture 13-16: 光线追踪与辐射度量学
   - 闫令琪老师讲解，中文授课

2. **TU Wien渲染课程**
   - 🎥 [YouTube播放列表](https://www.youtube.com/c/渲染课程)
   - 深入的辐射度量学理论

3. **Scratchapixel视频教程**
   - 🎥 配套文字教程的视频讲解
   - 从零开始的渲染教学

### 📊 交互式演示

1. **立体角可视化**
   - 🔗 [GeoGebra: Solid Angle](https://www.geogebra.org/m/HZ5NxGVu)
   - 交互式3D演示

2. **BRDF可视化工具**
   - 🔗 [Disney BRDF Explorer](https://github.com/wdas/brdf) - 下载使用
   - 🔗 [在线BRDF查看器](https://patapom.com/topics/Revision2013/Revision%202013%20-%20Real%20Shading%20in%20Unreal%20Engine%204.pdf)

3. **光照计算演示**
   - 🔗 [Shadertoy: 交互式着色器](https://www.shadertoy.com/view/4sfGDB)
   - 实时查看BRDF效果

### 📚 在线书籍与教程

1. **PBRT Book在线版**
   - 🔗 [pbr-book.org](https://www.pbr-book.org)
   - 完整的第三版在线阅读

2. **Scratchapixel完整教程**
   - 🔗 [scratchapixel.com](https://www.scratchapixel.com)
   - 从零开始的渲染教学

3. **Learn OpenGL - PBR章节**
   - 🔗 [learnopengl.com/PBR/Theory](https://learnopengl.com/PBR/Theory)
   - 实时渲染视角的辐射度量学

### 🖼️ 图片资源

1. **Wikipedia相关条目**
   - [Solid Angle](https://en.wikipedia.org/wiki/Solid_angle)
   - [Radiance](https://en.wikipedia.org/wiki/Radiance)
   - [BRDF](https://en.wikipedia.org/wiki/Bidirectional_reflectance_distribution_function)

2. **PBRT Book图片**
   - 所有插图都可以在[官网](https://pbr-book.org)找到
   - 高质量的示意图和渲染结果

### 💻 实践资源

1. **GitHub优秀项目列表**
   ```
   离线渲染器:
   - mmp/pbrt-v3 (C++)
   - mitsuba-renderer/mitsuba3 (C++/Python)
   - RayTracing/raytracing.github.io (C++)
   
   实时引擎:
   - google/filament (C++)
   - EpicGames/UnrealEngine (C++)
   
   教学项目:
   - ssloy/tinyrenderer (C++)
   - 99lines-of-code (各种语言的miniRT)
   ```

2. **在线编程环境**
   - 🔗 [Shadertoy](https://www.shadertoy.com) - GLSL在线编辑
   - 🔗 [Compiler Explorer](https://godbolt.org) - 查看编译优化

### 📖 论文资源

1. **经典论文**
   - Kajiya 1986: The Rendering Equation
   - Cook-Torrance 1982: Reflectance Model
   - Veach 1997: Robust Monte Carlo Methods

2. **论文获取**
   - [ACM Digital Library](https://dl.acm.org)
   - [Ke-Sen Huang's SIGGRAPH Papers](http://kesen.realtimerendering.com)
   - [Google Scholar](https://scholar.google.com)

---

祝学习顺利！记住：理解辐射度量学不是目的，它是通往全局光照的钥匙。🔑

**学习建议**:
- ✅ 理论+实践结合，每学一个概念就写代码验证
- ✅ 多看可视化工具，建立直觉
- ✅ 阅读优秀开源代码，学习工程实践
- ✅ 手推公式，特别是能量守恒验证
- ✅ 加入图形学社区（如知乎、Reddit r/GraphicsProgramming）交流

