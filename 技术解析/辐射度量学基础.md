# 辐射度量学(Radiometry)基础 - 深度解析

## 为什么要学习辐射度量学？

辐射度量学是理解全局光照的**物理基础**，它用精确的数学语言描述光的传播、测量和能量转换。没有辐射度量学，渲染方程就是一堆符号；有了辐射度量学，你就能理解每个像素背后的物理过程。

**学习目标**:
- 理解光作为电磁辐射的物理量
- 掌握描述光传播的四个核心辐射量
- 建立从物理世界到渲染算法的桥梁
- 为学习BRDF和渲染方程打下坚实基础

---

## 1. 立体角 (Solid Angle)

### 1.1 从平面角到立体角

在理解辐射量之前，我们先要理解**立体角**这个概念。

#### 平面角回顾
```
平面角 θ = 弧长 / 半径
        = s / r
单位: 弧度(radian)，圆周对应 2π 弧度
```

#### 立体角定义
立体角是平面角在三维空间的推广：

```
立体角 Ω = 面积 / 半径²
         = A / r²
单位: 球面度(steradian, sr)
```

**物理意义**: 立体角描述从某点看去一个表面"张开的大小"。

```
示例:
  半球面: Ω = 2π sr
  全球面: Ω = 4π sr
  一个小表面: Ω ≈ dA⊥ / r²
```

### 1.2 微分立体角

在渲染中，我们常用**球面坐标**表示方向：

```
方向向量 ω = (θ, φ)
  θ: 天顶角 (zenith angle)，[0, π]
  φ: 方位角 (azimuth angle)，[0, 2π]
```

微分立体角表达式：
```
dω = sin θ dθ dφ
```

**可视化**:
```
        Z (法线方向)
        ↑
        |   ω (光线方向)
        |  /
        | /θ
        |/______ Y
       O
      /
     / φ
    X

dω 表示球面上一小块区域对应的立体角
```

### 1.3 半球积分

在着色计算中，我们经常需要对半球面积分：

```
半球积分: ∫_Ω f(ω) dω

其中 Ω 表示以法线为轴的半球面
```

展开为球面坐标：
```
∫_Ω f(ω) dω = ∫₀²ᵖⁱ ∫₀ᵖⁱ/² f(θ, φ) sin θ dθ dφ
```

**常用公式**:
```
1. 半球面立体角: ∫_Ω dω = 2π

2. 余弦加权半球积分: 
   ∫_Ω cos θ dω = π

3. 投影立体角:
   dω⊥ = cos θ dω
```

---

## 2. 四个核心辐射量

辐射度量学用四个相互关联的物理量描述光的传播：

```
         能量 (Energy, Q)
            ↓ 对时间求导
       通量 (Flux, Φ)
          ↙        ↘
  对面积求导      对立体角求导
        ↓              ↓
   辐照度           辐射强度
  (Irradiance, E)  (Intensity, I)
        ↓              ↓
    对立体角求导    对面积求导
        ↘            ↙
       辐射亮度 (Radiance, L)
```

### 2.1 辐射能量 (Radiant Energy)

**定义**: 光携带的能量
- 符号: \( Q \)
- 单位: 焦耳 (Joule, J)

**物理意义**: 
- 单个光子能量: \( E = hν \) (h为普朗克常数，ν为频率)
- 渲染中通常不直接使用，而是用功率(通量)

---

### 2.2 辐射通量 (Radiant Flux / Power)

**定义**: 单位时间通过的辐射能量

\[
\Phi = \frac{dQ}{dt}
\]

- 符号: \( \Phi \)
- 单位: 瓦特 (Watt, W) = J/s

**物理意义**: 功率，描述光源发出或表面接收的总能量速率

**示例**:
```
点光源: 
  发光功率 Φ = 100W
  均匀发射，则每个立体角的强度 I = Φ / (4π)

太阳光:
  总功率约 3.8 × 10²⁶ W
  到达地球表面约 1000 W/m²
```

**在渲染中**:
- 光源的"brightness"参数常表示通量
- Area Light的总功率 = 辐射亮度 × 面积 × π

---

### 2.3 辐射强度 (Radiant Intensity)

**定义**: 单位立体角上的辐射通量

\[
I(\omega) = \frac{d\Phi}{d\omega}
\]

- 符号: \( I \)
- 单位: W/sr (瓦特每球面度)

**物理意义**: 描述点光源在某个方向上的"亮度"

**特点**:
- 只适用于**点光源** (0维光源)
- 与距离无关 (点光源的固有属性)
- 方向相关 (可以有方向性)

**示例**:
```cpp
// 均匀点光源 (Omnidirectional)
float I_uniform = Power / (4.0 * PI);

// 方向性光源 (Spotlight)
float I_spot(vec3 direction) {
    float cosTheta = dot(direction, lightDir);
    if (cosTheta > cosCutoff) {
        return Power * spotlight_falloff(cosTheta);
    }
    return 0.0;
}
```

**反平方衰减定律**:
```
从点光源出发的光，在距离 r 处的辐照度:
E(r) = I / r²

这就是著名的 1/r² 衰减！
```

---

### 2.4 辐照度 (Irradiance)

**定义**: 单位面积上接收的辐射通量

\[
E(p) = \frac{d\Phi}{dA}
\]

- 符号: \( E \)
- 单位: W/m² (瓦特每平方米)

**物理意义**: 表面某点接收到的"光照强度"

**完整定义** (考虑入射角):
\[
E(p) = \int_{\Omega} L_i(p, \omega) \cos\theta \, d\omega
\]

其中 \( \cos\theta \) 是Lambert余弦定律的体现。

**示例场景**:
```
地面上的辐照度:
  直射阳光: E ≈ 1000 W/m²
  阴天: E ≈ 100-300 W/m²
  室内: E ≈ 10-100 W/m²
  月光: E ≈ 1 W/m²
```

**Lambert余弦定律**:
```
      光源
        ↓ 
     ━━━━━━  ← 垂直表面，E = E₀
        
     ╱╱╱╱╱╱  ← 倾斜θ角，E = E₀ cos θ
```

**代码示例**:
```cpp
// 点光源产生的辐照度
float pointLightIrradiance(vec3 position, vec3 normal) {
    vec3 L = lightPos - position;
    float dist = length(L);
    L = L / dist; // 归一化
    
    float I = lightIntensity; // 辐射强度
    float cosTheta = max(0.0, dot(normal, L));
    
    return I * cosTheta / (dist * dist); // E = I·cosθ / r²
}
```

---

### 2.5 辐射亮度 (Radiance) ⭐ 核心概念

**定义**: 单位投影面积、单位立体角上的辐射通量

\[
L(p, \omega) = \frac{d^2\Phi}{dA^\perp \, d\omega} = \frac{d^2\Phi}{dA \cos\theta \, d\omega}
\]

- 符号: \( L \)
- 单位: W/(m²·sr) (瓦特每平方米每球面度)

**物理意义**: 
- 描述光在空间中某点、某方向上的"密度"
- **渲染方程的核心量** - 我们计算的就是Radiance！

**为什么Radiance如此重要？**

1. **不随距离衰减**: 
   ```
   光线在真空中传播，Radiance保持不变！
   (这就是为什么远处的星星依然明亮)
   ```

2. **摄像机测量的是Radiance**:
   ```
   像素值 ∝ L(p, ω_camera)
   ```

3. **渲染方程求解的是Radiance**:
   ```
   L_o(p, ω_o) = L_e(p, ω_o) + ∫_Ω f_r(p, ω_i, ω_o) L_i(p, ω_i) cosθ_i dω_i
   ```

### Radiance的两个视角

**1. 从表面出发** (Exitant Radiance):
```
L_o(p, ω) = 单位面积、单位立体角发出的通量
```

**2. 向表面入射** (Incident Radiance):
```
L_i(p, ω) = 单位面积、单位立体角到达的通量
```

**关系图**:
```
    光源                表面
     L_e    ──→    L_i  →  反射  →  L_o  ──→  摄像机
  (发射亮度)   (入射亮度)    (BRDF)  (出射亮度)
```

---

## 3. 辐射量之间的关系

### 3.1 从点光源到表面

```
点光源 (Intensity I)
    ↓ 传播距离 r
入射辐照度: E = I / r²
    ↓ 从立体角推导
入射辐射亮度: L_i = I / r²  (对于小光源)

实际上: L_i = I / (dA_light · cos θ_light)
```

### 3.2 从面光源到表面

```
面光源 (Radiance L, 面积 A)
    ↓
总通量: Φ = L · A · π  (Lambertian发射器)
    ↓
某点接收的辐照度: E = ∫_A L · cos θ_i · cos θ_o / r² dA_light
```

### 3.3 辐照度与辐射亮度

关键公式：
\[
E(p) = \int_{\Omega} L_i(p, \omega) \cos\theta \, d\omega
\]

**均匀环境光照下**:
\[
E = \int_{\Omega} L_{env} \cos\theta \, d\omega = L_{env} \cdot \pi
\]

这就是为什么 **π** 在渲染中无处不在！

---

## 4. BRDF - 双向反射分布函数

### 4.1 BRDF的定义

**Bidirectional Reflectance Distribution Function**

\[
f_r(p, \omega_i, \omega_o) = \frac{dL_o(p, \omega_o)}{dE_i(p, \omega_i)} = \frac{dL_o(p, \omega_o)}{L_i(p, \omega_i) \cos\theta_i \, d\omega_i}
\]

- 单位: sr⁻¹ (1/球面度)

**物理意义**: 从方向 \(\omega_i\) 入射的光，有多少比例反射到方向 \(\omega_o\)

**BRDF的特性**:

1. **非负性**: 
   ```
   f_r(ω_i, ω_o) ≥ 0
   ```

2. **Helmholtz互易性**:
   ```
   f_r(ω_i, ω_o) = f_r(ω_o, ω_i)
   (交换入射和出射方向，BRDF不变)
   ```

3. **能量守恒**:
   ```
   ∫_Ω f_r(ω_i, ω_o) cos θ_o dω_o ≤ 1
   (反射的能量不能超过入射能量)
   ```

### 4.2 常见BRDF模型

#### 1. Lambertian (完全漫反射)

\[
f_r = \frac{\rho}{\pi}
\]

- \(\rho\): 反射率 (albedo)，取值 [0, 1]
- 各向同性，所有方向反射均匀

```cpp
vec3 lambertianBRDF(vec3 albedo) {
    return albedo / PI;
}
```

**为什么除以π?**
```
能量守恒:
∫_hemisphere f_r cos θ dω = ρ/π · π = ρ ≤ 1 ✓
```

#### 2. 完美镜面 (Perfect Specular)

\[
f_r(p, \omega_i, \omega_o) = \frac{\rho_s}{\cos\theta_i} \delta(\omega_o - \omega_r)
\]

- \(\omega_r\): 镜面反射方向
- \(\delta\): Dirac delta函数

```cpp
vec3 reflect(vec3 I, vec3 N) {
    return I - 2.0 * dot(N, I) * N;
}
```

#### 3. Microfacet模型 (Cook-Torrance)

用于表示有一定粗糙度的表面：

\[
f_r(\omega_i, \omega_o) = \frac{D(\omega_h) G(\omega_i, \omega_o) F(\omega_i, \omega_h)}{4 \cos\theta_i \cos\theta_o}
\]

- \(D\): 法线分布函数 (Normal Distribution Function)
- \(G\): 几何遮挡函数 (Geometry Function)
- \(F\): 菲涅尔项 (Fresnel Term)
- \(\omega_h\): 半向量 (half vector)

**常用的NDF - GGX**:
\[
D_{GGX}(\omega_h) = \frac{\alpha^2}{\pi ((\cos\theta_h)^2 (\alpha^2 - 1) + 1)^2}
\]

```cpp
float D_GGX(float NoH, float roughness) {
    float a = roughness * roughness;
    float a2 = a * a;
    float NoH2 = NoH * NoH;
    float denom = NoH2 * (a2 - 1.0) + 1.0;
    return a2 / (PI * denom * denom);
}
```

### 4.3 BTDF和BSDF

**BTDF** (Bidirectional Transmittance Distribution Function):
- 描述透射(折射)
- 用于玻璃、水等透明材质

**BSDF** (Bidirectional Scattering Distribution Function):
- BSDF = BRDF + BTDF
- 统一描述反射和透射

\[
f_s = f_r + f_t
\]

---

## 5. 辐射度量学在渲染中的应用

### 5.1 渲染方程

有了辐射度量学基础，我们就能理解渲染方程：

\[
L_o(p, \omega_o) = L_e(p, \omega_o) + \int_{\Omega} f_r(p, \omega_i, \omega_o) L_i(p, \omega_i) \cos\theta_i \, d\omega_i
\]

**每一项的含义**:
- \(L_o\): 出射辐射亮度 (我们要求解的)
- \(L_e\): 自发光 (Emission)
- \(f_r\): BRDF (材质属性)
- \(L_i\): 入射辐射亮度 (来自其他表面或光源)
- \(\cos\theta_i\): Lambert余弦
- \(d\omega_i\): 积分所有入射方向

### 5.2 直接光照计算

**点光源**:
```cpp
vec3 directLighting(vec3 position, vec3 normal, vec3 viewDir) {
    // 光源方向
    vec3 L = normalize(lightPos - position);
    float dist = length(lightPos - position);
    
    // 入射辐射亮度 (来自点光源)
    float I = lightIntensity; // W/sr
    vec3 L_i = I / (dist * dist); // W/m²
    
    // BRDF
    vec3 f_r = albedo / PI; // Lambertian
    
    // 余弦项
    float cosTheta = max(0.0, dot(normal, L));
    
    // 出射辐射亮度
    return f_r * L_i * cosTheta;
}
```

**面光源**:
```cpp
vec3 areaLightContribution(vec3 position, vec3 normal) {
    vec3 L_o = vec3(0.0);
    
    // 对面光源采样
    for (int i = 0; i < numSamples; i++) {
        vec3 lightPoint = sampleAreaLight();
        vec3 L = normalize(lightPoint - position);
        float dist = length(lightPoint - position);
        
        // 光源上的辐射亮度
        vec3 L_i = lightRadiance / (dist * dist);
        
        // BRDF · L_i · cosθ
        float cosTheta = max(0.0, dot(normal, L));
        L_o += (albedo / PI) * L_i * cosTheta;
    }
    
    return L_o / numSamples;
}
```

### 5.3 环境光遮蔽 (Ambient Occlusion)

环境光遮蔽本质上是辐照度的可见性加权：

\[
AO(p) = \frac{1}{\pi} \int_{\Omega} V(p, \omega) \cos\theta \, d\omega
\]

- \(V(p, \omega)\): 可见性函数 (0或1)

```cpp
float computeAO(vec3 position, vec3 normal, int numSamples) {
    float occlusion = 0.0;
    
    for (int i = 0; i < numSamples; i++) {
        vec3 direction = sampleHemisphere(normal);
        float cosTheta = dot(normal, direction);
        
        // 光线追踪检测遮挡
        if (rayIntersect(position, direction)) {
            occlusion += cosTheta; // 被遮挡
        }
    }
    
    return 1.0 - (occlusion / (numSamples * PI));
}
```

---

## 6. 常见误区与注意事项

### ❌ 误区1: 混淆辐照度和辐射亮度

```
错误: "光源亮度是辐照度"
正确: 
  - 点光源用辐射强度描述
  - 面光源用辐射亮度描述
  - 表面接收的是辐照度
```

### ❌ 误区2: 忘记cosθ项

```
错误: E = ∫ L dω
正确: E = ∫ L cos θ dω

Lambert余弦定律必不可少！
```

### ❌ 误区3: BRDF单位错误

```
错误: BRDF单位是 "无量纲"
正确: BRDF单位是 sr⁻¹

f_r = dL_o / (L_i cos θ dω)
单位: (W/(m²·sr)) / (W/m²) = sr⁻¹
```

### ❌ 误区4: 能量不守恒

```
错误: Lambertian BRDF = albedo
正确: Lambertian BRDF = albedo / π

验证能量守恒:
∫ (ρ/π) cos θ dω = ρ ≤ 1 ✓
```

---

## 7. 实践练习

### 练习1: 推导点光源的辐照度

**题目**: 一个辐射强度为 I = 100 W/sr 的点光源，距离表面 r = 2m，求表面的辐照度（法线朝向光源）。

<details>
<summary>点击查看答案</summary>

```
解:
1. 点光源的辐射强度: I = 100 W/sr

2. 距离 r = 2m 处，微分立体角:
   dω = dA / r²

3. 接收的通量:
   dΦ = I · dω = I · dA / r²

4. 辐照度定义:
   E = dΦ / dA = I / r²
   
5. 代入数值:
   E = 100 / 4 = 25 W/m²

答案: E = 25 W/m²
```
</details>

### 练习2: 验证Lambertian能量守恒

**题目**: 证明 Lambertian BRDF \( f_r = \rho / \pi \) 满足能量守恒。

<details>
<summary>点击查看答案</summary>

```
证明:
能量守恒条件: ∫_Ω f_r(ω_i, ω_o) cos θ_o dω_o ≤ 1

对于Lambertian BRDF:
f_r = ρ / π (常数)

积分:
∫_Ω (ρ/π) cos θ dω

= (ρ/π) ∫₀²ᵖⁱ ∫₀ᵖⁱ/² cos θ · sin θ dθ dφ

= (ρ/π) · 2π · ∫₀ᵖⁱ/² cos θ sin θ dθ

= (ρ/π) · 2π · [sin²θ / 2]₀ᵖⁱ/²

= (ρ/π) · 2π · 1/2

= ρ

结论: 只要 ρ ≤ 1，就满足能量守恒 ✓
```
</details>

### 练习3: 计算半球辐照度

**题目**: 均匀环境光 \( L_{env} = 1 \, W/(m^2 \cdot sr) \)，计算平面接收的总辐照度。

<details>
<summary>点击查看答案</summary>

```
解:
E = ∫_Ω L_env cos θ dω

= L_env ∫₀²ᵖⁱ ∫₀ᵖⁱ/² cos θ sin θ dθ dφ

= L_env · 2π · [sin²θ / 2]₀ᵖⁱ/²

= L_env · 2π · 1/2

= L_env · π

代入 L_env = 1:
E = π W/m²

答案: E = π ≈ 3.14 W/m²

这就是著名的 "π因子"！
```
</details>

---

## 8. 进阶话题

### 8.1 光谱辐射度量学

实际上，所有辐射量都是波长相关的：

\[
L(\lambda, p, \omega) \quad \text{单位: W/(m²·sr·nm)}
\]

在渲染中的简化：
- RGB三通道分别计算
- 或使用SPD (Spectral Power Distribution)

### 8.2 光度学 (Photometry)

光度学是辐射度量学的感知版本，加入了人眼响应：

| 辐射量 | 光度量 | 单位 |
|--------|--------|------|
| Radiant Flux | Luminous Flux | 流明(lm) |
| Radiance | Luminance | cd/m² |
| Irradiance | Illuminance | 勒克斯(lux) |

转换关系：
\[
\Phi_v = 683 \int V(\lambda) \Phi_e(\lambda) d\lambda
\]

- \(V(\lambda)\): 人眼视觉效率函数 (CIE 1931)
- 峰值在 555nm (绿光)

### 8.3 次表面散射 (Subsurface Scattering)

对于半透明材质，光会进入表面内部：

\[
L_o(p_o, \omega_o) = \int_A \int_{\Omega} S(p_i, \omega_i; p_o, \omega_o) L_i(p_i, \omega_i) \cos\theta_i \, d\omega_i \, dA(p_i)
\]

- \(S\): BSSRDF (Bidirectional Surface Scattering Reflectance Distribution Function)
- 比BRDF多了一个空间维度

---

## 9. 学习资源与路线图

### 推荐阅读顺序

1. **入门** (1-2天):
   - GAMES101 Lecture 13-14
   - 理解四个辐射量的定义

2. **深入** (3-5天):
   - PBRT Chapter 5.4-5.6
   - 手推公式，特别是半球积分

3. **实践** (1周):
   - 实现简单的路径追踪器
   - 验证辐射量的计算

4. **进阶** (持续):
   - "Advanced Global Illumination" Chapter 2
   - "Radiometry and Reflectance" 论文

### 核心公式速查表

```
立体角: dω = sin θ dθ dφ

半球积分: ∫_Ω dω = 2π

余弦加权: ∫_Ω cos θ dω = π

Radiance → Irradiance:
E = ∫_Ω L cos θ dω

点光源辐照度:
E = I cos θ / r²

BRDF定义:
f_r = dL_o / (L_i cos θ_i dω_i)

Lambertian BRDF:
f_r = ρ / π

渲染方程:
L_o = L_e + ∫_Ω f_r L_i cos θ dω
```

---

## 10. 常见问题 FAQ

**Q1: 为什么渲染中到处都是π？**

A: 因为半球积分！
```
∫_hemisphere cos θ dω = π
这是Lambertian材质能量守恒的关键。
```

**Q2: Radiance为什么不随距离衰减？**

A: Radiance是"密度"概念：
```
虽然总能量随距离平方衰减，但
立体角也随距离平方衰减，
两者相抵，Radiance保持不变！
```

**Q3: 如何理解BRDF的单位 sr⁻¹？**

A: BRDF是"比率"：
```
f_r = (出射Radiance增量) / (入射Irradiance增量)
    = [W/(m²·sr)] / [W/m²]
    = sr⁻¹
```

**Q4: 实际渲染需要计算所有这些量吗？**

A: 现代渲染器通常只计算Radiance：
```
Path Tracing: 追踪Radiance
Rasterization: 计算辐照度，然后转换为Radiance
```

---

## 11. 下一步学习

掌握辐射度量学后，你已经准备好学习：

✅ **渲染方程** - 理解全局光照的数学基础
✅ **蒙特卡洛积分** - 数值求解渲染方程
✅ **路径追踪** - 实现第一个GI算法
✅ **BRDF模型** - 深入理解材质表示

**验收标准**:
- [ ] 能解释四个辐射量的物理意义和单位
- [ ] 能推导点光源的辐照度公式
- [ ] 理解BRDF的定义和能量守恒
- [ ] 能手写渲染方程并解释每一项
- [ ] 知道为什么Lambertian要除以π

---

**文档版本**: v1.0  
**创建日期**: 2025年10月  
**预计学习时间**: 1-2周  
**难度**: ⭐⭐☆☆☆  
**前置知识**: 微积分、基础物理

---

## 参考文献

1. **Pharr, M., Jakob, W., & Humphreys, G.** (2016). *Physically Based Rendering: From Theory to Implementation* (3rd ed.). Chapter 5.
2. **Dutré, P., Bekaert, P., & Bala, K.** (2006). *Advanced Global Illumination* (2nd ed.). Chapter 2.
3. **Nicodemus, F. E.** (1965). "Directional Reflectance and Emissivity of an Opaque Surface". *Applied Optics*.
4. **Veach, E.** (1997). *Robust Monte Carlo Methods for Light Transport Simulation*. PhD Thesis, Chapter 2.

祝学习顺利！记住：理解辐射度量学不是目的，它是通往全局光照的钥匙。🔑

